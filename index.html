<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Living Envelope Tracker</title>
  <meta name="theme-color" content="#111111" />
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --text:#f3f4f6; --muted:#a7b0c0;
      --good:#4ade80; --warn:#fbbf24; --bad:#fb7185; --line:#2a2f3a;
      --btn:#2b3240; --btn2:#1f2530;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg); color:var(--text); padding:16px;
    }
    .wrap{max-width:520px; margin:0 auto; display:flex; flex-direction:column; gap:12px;}
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:14px;
    }
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between;}
    h1{font-size:18px; margin:0}
    h2{font-size:14px; margin:0; color:var(--muted); font-weight:600; letter-spacing:.2px}
    .big{font-size:34px; font-weight:750; line-height:1.1; margin:6px 0 2px}
    .sub{color:var(--muted); font-size:12px}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px; background:#10131a; border:1px solid var(--line);
      color:var(--muted);
    }
    .bar{
      height:10px; width:100%; border-radius:999px; background:#0b0d12; border:1px solid var(--line);
      overflow:hidden;
    }
    .fill{height:100%; width:0%; background:var(--good);}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:#0b0d12; color:var(--text); font-size:16px;
    }
    .btnrow{display:flex; gap:10px; margin-top:10px;}
    button{
      flex:1; border:1px solid var(--line); background:var(--btn); color:var(--text);
      padding:12px 12px; border-radius:12px; font-size:15px; font-weight:650;
    }
    button.secondary{background:var(--btn2); color:var(--muted); font-weight:600;}
    button.danger{background:#2a1118; border-color:#3b1520; color:#ffb4c2;}
    .list{margin-top:10px; display:flex; flex-direction:column; gap:8px;}
    .item{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      padding:10px; border:1px solid var(--line); border-radius:12px; background:#0b0d12;
    }
    .item .meta{display:flex; flex-direction:column; gap:2px;}
    .item .cat{font-size:12px; color:var(--muted)}
    .item .note{font-size:13px}
    .amt{font-size:14px; font-weight:700; white-space:nowrap;}
    .smallbtn{
      border:none; background:transparent; color:var(--muted); font-size:12px; padding:0; margin-top:4px;
      text-decoration:underline; cursor:pointer;
    }
    .footer{font-size:12px; color:var(--muted); text-align:center; padding:6px 0 14px;}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <div class="row">
        <div>
          <h1>True Living Envelope</h1>
          <div class="sub" id="monthLabel"></div>
        </div>
        <div class="pill" id="capLabel">Cap: S$2,602</div>
      </div>

      <div class="big" id="remaining">S$0</div>
      <div class="sub">
        Spent: <span id="spent">S$0</span> · Remaining: <span id="remain2">S$0</span>
      </div>

      <div style="margin-top:10px">
        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="sub" style="margin-top:6px" id="status">Status</div>
      </div>
    </div>

    <div class="card">
      <h2>Add an expense</h2>
      <div class="grid">
        <div>
          <label for="amount">Amount (S$)</label>
          <input id="amount" inputmode="decimal" placeholder="e.g., 12.50" />
        </div>
        <div>
          <label for="category">Category</label>
          <select id="category">
            <option>Food and dining</option>
            <option>Transport</option>
            <option>Subscriptions</option>
            <option>Personal spending</option>
            <option>Entertainment</option>
            <option>Family top-ups</option>
            <option>Misc</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px">
        <label for="note">Note (optional)</label>
        <input id="note" placeholder="e.g., lunch, Grab, movie" />
      </div>
      <div class="btnrow">
        <button id="addBtn">Add</button>
        <button class="secondary" id="quick10">+10</button>
        <button class="secondary" id="quick20">+20</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <h2>Recent expenses</h2>
        <div class="pill" id="countLabel">0 items</div>
      </div>
      <div class="list" id="list"></div>

      <div class="btnrow" style="margin-top:12px">
        <button class="secondary" id="exportBtn">Export CSV</button>
        <button class="danger" id="resetMonthBtn">Reset month</button>
      </div>

      <div style="margin-top:10px" class="sub">
        Tip: Use Reset month on the 1st of each month. Data stays on your phone only.
      </div>
    </div>

    <div class="footer">
      Envelope cap default: S$2,602. You can change it in the code if needed.
    </div>

  </div>

<script>
  // ======= Settings =======
  const DEFAULT_CAP = 2602;

  // ======= Storage helpers =======
  const key = (suffix) => `livingEnvelope_${suffix}`;
  const now = () => new Date();
  const ym = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

  function loadState() {
    const month = localStorage.getItem(key("month")) || ym(now());
    const cap = Number(localStorage.getItem(key("cap")) || DEFAULT_CAP);
    const items = JSON.parse(localStorage.getItem(key("items")) || "[]");
    return { month, cap, items };
  }

  function saveState(state) {
    localStorage.setItem(key("month"), state.month);
    localStorage.setItem(key("cap"), String(state.cap));
    localStorage.setItem(key("items"), JSON.stringify(state.items));
  }

  function ensureMonthRoll() {
    const state = loadState();
    const current = ym(now());
    if (state.month !== current) {
      // Auto-archive by resetting items for the new month.
      // If you want to keep history, we can extend this to store per-month arrays.
      state.month = current;
      state.items = [];
      saveState(state);
    }
  }

  function formatMoney(n) {
    const v = Math.round((Number(n) + Number.EPSILON) * 100) / 100;
    return `S$${v.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2})}`;
  }

  function totalSpent(items) {
    return items.reduce((sum, x) => sum + Number(x.amount || 0), 0);
  }

  function statusFor(pct) {
    if (pct < 70) return { text: "Comfortable. Keep going.", color: "var(--good)" };
    if (pct < 90) return { text: "Caution zone. Slow down.", color: "var(--warn)" };
    if (pct <= 100) return { text: "Red zone. Only essentials now.", color: "var(--bad)" };
    return { text: "Over cap. Stop discretionary spending.", color: "var(--bad)" };
  }

  // ======= UI wiring =======
  const el = (id) => document.getElementById(id);

  function render() {
    ensureMonthRoll();
    const state = loadState();

    const spent = totalSpent(state.items);
    const remaining = state.cap - spent;
    const pct = state.cap === 0 ? 0 : (spent / state.cap) * 100;
    const pctClamped = Math.max(0, Math.min(100, pct));

    el("capLabel").textContent = `Cap: ${formatMoney(state.cap).replace(".00","")}`;
    el("spent").textContent = formatMoney(spent);
    el("remaining").textContent = formatMoney(Math.max(0, remaining));
    el("remain2").textContent = formatMoney(remaining);

    const status = statusFor(pct);
    el("status").textContent = `${status.text} (${pct.toFixed(0)}% used)`;
    el("status").style.color = status.color;

    const fill = el("fill");
    fill.style.width = `${pctClamped}%`;
    fill.style.background = status.color;

    // Month label
    const [Y, M] = state.month.split("-");
    const monthName = new Date(Number(Y), Number(M)-1, 1).toLocaleString(undefined, { month: "long", year: "numeric" });
    el("monthLabel").textContent = monthName;

    // List
    const list = el("list");
    list.innerHTML = "";
    const recent = state.items.slice().reverse().slice(0, 12);

    el("countLabel").textContent = `${state.items.length} items`;

    if (recent.length === 0) {
      const empty = document.createElement("div");
      empty.className = "sub";
      empty.textContent = "No expenses yet. Add your first one above.";
      list.appendChild(empty);
      return;
    }

    for (const item of recent) {
      const row = document.createElement("div");
      row.className = "item";

      const meta = document.createElement("div");
      meta.className = "meta";

      const cat = document.createElement("div");
      cat.className = "cat";
      cat.textContent = item.category;

      const note = document.createElement("div");
      note.className = "note";
      const ts = new Date(item.ts);
      const when = ts.toLocaleString(undefined, { day: "2-digit", month: "short", hour: "2-digit", minute: "2-digit" });
      note.textContent = (item.note ? item.note : "No note") + ` · ${when}`;

      meta.appendChild(cat);
      meta.appendChild(note);

      const right = document.createElement("div");
      right.style.textAlign = "right";

      const amt = document.createElement("div");
      amt.className = "amt";
      amt.textContent = formatMoney(item.amount);

      const del = document.createElement("button");
      del.className = "smallbtn";
      del.textContent = "Delete";
      del.onclick = () => {
        const state2 = loadState();
        state2.items = state2.items.filter(x => x.id !== item.id);
        saveState(state2);
        render();
      };

      right.appendChild(amt);
      right.appendChild(del);

      row.appendChild(meta);
      row.appendChild(right);

      list.appendChild(row);
    }
  }

  function addExpense(amount, category, note) {
    const a = Number(amount);
    if (!Number.isFinite(a) || a <= 0) return alert("Enter a valid amount.");

    const state = loadState();
    state.items.push({
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
      amount: Math.round(a * 100) / 100,
      category,
      note: (note || "").trim(),
      ts: new Date().toISOString()
    });
    saveState(state);
    render();
  }

  el("addBtn").addEventListener("click", () => {
    addExpense(el("amount").value, el("category").value, el("note").value);
    el("amount").value = "";
    el("note").value = "";
    el("amount").focus();
  });

  function quickAdd(n) {
    addExpense(n, el("category").value, el("note").value || `Quick add ${n}`);
  }

  el("quick10").addEventListener("click", () => quickAdd(10));
  el("quick20").addEventListener("click", () => quickAdd(20));

  el("resetMonthBtn").addEventListener("click", () => {
    const ok = confirm("Reset this month? This clears the list for the current month.");
    if (!ok) return;
    const state = loadState();
    state.items = [];
    saveState(state);
    render();
  });

  el("exportBtn").addEventListener("click", () => {
    const state = loadState();
    const rows = [
      ["month","timestamp","category","amount","note"]
    ];
    for (const item of state.items) {
      rows.push([state.month, item.ts, item.category, item.amount, (item.note || "").replaceAll('"','""')]);
    }
    const csv = rows.map(r => r.map(v => `"${v}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `living-envelope-${state.month}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Initialize defaults once
  (function init(){
    ensureMonthRoll();
    const state = loadState();
    if (!localStorage.getItem(key("cap"))) {
      state.cap = DEFAULT_CAP;
      saveState(state);
    }
    render();
  })();
</script>
</body>
</html>
